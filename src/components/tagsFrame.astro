---
import TagsWaterfallFrame from './TagsWaterfallFrame.tsx';
import { getCollection, type CollectionEntry } from 'astro:content';
import { sortPostsByDate } from '../utils/date';

// 获取所有文章
const posts = await getCollection('posts');

// 按标签分组
interface TagGroup {
    tag: string;
    posts: CollectionEntry<"posts">[];
    count: number;
}

const tagGroups: TagGroup[] = (() => {
    const tagMap = new Map<string, CollectionEntry<"posts">[]>();

    posts.forEach(post => {
        post.data.tags.forEach(tag => {
            if (!tagMap.has(tag)) {
                tagMap.set(tag, []);
            }
            tagMap.get(tag)!.push(post);
        });
    });

    return Array.from(tagMap.entries())
        .map(([tag, posts]) => ({
            tag,
            posts: sortPostsByDate(posts),
            count: posts.length,
        }))
        .sort((a, b) => b.count - a.count);
})();

const totalPosts = posts.length;
const totalTags = tagGroups.length;
---

<suspense fallback="Loading...">
    <TagsWaterfallFrame tagGroups={tagGroups} totalPosts={totalPosts} totalTags={totalTags} client:load />
</suspense>